<script>
  setInterval(() => location.reload(), 5 * 60 * 1000);

  fetch("/data/fear-greed.json")
    .then(res => res.json())
    .then(data => {
      const box = document.getElementById("greedBox");
      const score = data.value;
      box.textContent = `Fear & Greed Index: ${score} (${data.status})`;

      const n = parseInt(score);
      if (n >= 75) box.className = "greed-box green";
      else if (n >= 50) box.className = "greed-box yellow";
      else if (n >= 25) box.className = "greed-box orange";
      else box.className = "greed-box red";
    });

  fetch("/data/momentum.json")
    .then(res => res.json())
    .then(coins => {
      const tbody = document.querySelector("#momentumTable tbody");
      tbody.innerHTML = coins.map(c => `
        <tr>
          <td>${c.name}</td>
          <td>$${parseFloat(c.price).toLocaleString()}</td>
          <td style="color: ${c.change >= 0 ? 'green' : 'red'};">${c.change.toFixed(2)}%</td>
        </tr>
      `).join("");
    });

  fetch("/data/fear-greed-history.json")
    .then(res => res.json())
    .then(history => {
      const labels = history.map(h => h.date);
      const values = history.map(h => h.value);

      const minValue = Math.min(...values);
      const maxValue = Math.max(...values);
      const minIndex = values.indexOf(minValue);
      const maxIndex = values.indexOf(maxValue);

      const pointColors = values.map((_, i) => {
        if (i === minIndex) return '#2ecc71'; // Green for min
        if (i === maxIndex) return '#e74c3c'; // Red for max
        return '#6a1b9a'; // Default purple
      });

      const pointRadius = values.map((_, i) => (i === minIndex || i === maxIndex ? 6 : 3));
      const pointHoverRadius = values.map((_, i) => (i === minIndex || i === maxIndex ? 8 : 5));

      const ctx = document.getElementById("sentimentChart").getContext("2d");
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Fear & Greed Index',
            data: values,
            fill: true,
            backgroundColor: 'rgba(106, 27, 154, 0.1)',
            borderColor: '#6a1b9a',
            borderWidth: 2,
            tension: 0.4,
            pointBackgroundColor: pointColors,
            pointRadius,
            pointHoverRadius
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false
            },
            legend: {
              display: false
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          scales: {
            x: {
              title: { display: true, text: 'Date' },
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            y: {
              beginAtZero: true,
              suggestedMax: 100,
              title: { display: true, text: 'Index Value' },
              grid: { color: 'rgba(0,0,0,0.1)' }
            }
          }
        }
      });
    });
</script>
