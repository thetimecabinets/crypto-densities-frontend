<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🐋 Whale Wall Tracker – CryptoDensities.pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Track real-time crypto whale buy and sell walls by coin. Visualize price levels with high liquidity resistance.">
  <style>
    /* (CSS remains unchanged) */
  </style>
</head>
<body>

<!-- Existing layout remains unchanged -->

<script>
let rawData = [];
let activeCoin = "";
let seenAlerts = new Set();
let coinInsights = {}; // NEW

function formatNumberShort(n) {
  if (!n || isNaN(n)) return "N/A";
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toString();
}

async function fetchInsights() {
  try {
    const res = await fetch("https://api.cryptodensities.pro/api/insights");
    coinInsights = await res.json();
  } catch (err) {
    console.error("Failed to fetch insights:", err);
  }
}

async function fetchData() {
  try {
    await fetchInsights();
    const res = await fetch("https://api.cryptodensities.pro/api/walls");
    rawData = await res.json();
    renderTabs();
    renderTables();
    checkAlerts();
  } catch (err) {
    console.error("Failed to fetch data:", err);
  }
}

function renderTabs() {
  const tabs = document.getElementById("coinTabs");
  let coins = [...new Set(rawData.map(w => w.coin))];
  coins.sort((a, b) => (a === "BTC" ? -1 : b === "BTC" ? 1 : a === "ETH" ? -1 : b === "ETH" ? 1 : a.localeCompare(b)));

  if (!coins.includes(activeCoin)) {
    activeCoin = coins[0];
  }

  tabs.innerHTML = coins.map(coin => `
    <button class="tab-button ${coin === activeCoin ? 'active' : ''}" onclick="setActiveCoin('${coin}')">${coin}</button>
  `).join("");
}

function setActiveCoin(coin) {
  activeCoin = coin;
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  document.querySelectorAll(".tab-button").forEach(btn => {
    if (btn.innerText === coin) btn.classList.add("active");
  });
  renderTables();
}

function renderTables() {
  const container = document.getElementById("coinTablesContainer");
  container.innerHTML = "";
  const exchange = document.getElementById("exchangeFilter").value;
  const type = document.getElementById("typeFilter").value;
  const value = parseFloat(document.getElementById("valueFilter").value) || 0;
  const ageFilter = document.getElementById("ageFilter").value;

  const filtered = rawData.filter(w =>
    w.coin === activeCoin &&
    (!exchange || w.exchange === exchange) &&
    (!type || w.type === type) &&
    (!value || w.value >= value) &&
    (!ageFilter || (ageFilter === ">86400" && w.age_seconds > 86400) || (ageFilter !== ">86400" && w.age_seconds <= parseFloat(ageFilter)))
  );

  const rows = filtered.map(w => {
    let icon = w.age_seconds <= 60 ? "🆕" : w.value > 1000000 ? "🔥" : w.value > 500000 ? "🐋" : "";
    const pulseClass = w.age_seconds <= 60 ? "pulse" : "";
    const insight = `Coin: ${w.coin}\nType: ${w.type.toUpperCase()}\nPrice: $${w.price}\nValue: $${Math.round(w.value)}\nAge: ${w.age}\nExchange: ${w.exchange}`;
    return `
      <tr class="${pulseClass}" title="${insight}">
        <td class="${w.type}">${icon} ${w.type.charAt(0).toUpperCase() + w.type.slice(1)}</td>
        <td>${w.exchange}</td>
        <td>${w.price.toLocaleString()}</td>
        <td>${w.quantity}</td>
        <td>$${formatNumberShort(w.value)}</td>
        <td>${w.distance}</td>
        <td>${w.age}</td>
        <td>${w.volatility ?? 'N/A'}</td>
        <td>${w.volume ?? 'N/A'}</td>
      </tr>
    `;
  }).join("");

  const insight = coinInsights[activeCoin];
  let insightsHTML = "";
  if (insight) {
    insightsHTML = `
      <div style="background:#fff; padding:15px; border-radius:12px; margin-bottom:20px; box-shadow:0 0 10px rgba(0,0,0,0.05);">
        <h3>🔍 ${activeCoin} Wall Insights</h3>
        <p>📊 Wall Count: <strong>${insight.wall_count}</strong></p>
        <p>💰 Avg Value: <strong>$${formatNumberShort(insight.average_value)}</strong></p>
        <p>📏 Avg Distance: <strong>${insight.average_distance}%</strong></p>
        <p>⚖️ Buy/Sell Ratio: <strong>${(insight.buy_ratio * 100).toFixed(0)}% Buy / ${(insight.sell_ratio * 100).toFixed(0)}% Sell</strong></p>
      </div>
    `;
  }

  container.innerHTML = `
    ${insightsHTML}
    <table class="coin-table active">
      <thead>
        <tr>
          <th>Type</th><th>Exchange</th><th>Price ($)</th><th>Quantity</th>
          <th>Value ($)</th><th>Distance (%)</th><th>Age</th><th>Volatility</th><th>Volume</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function showAlert(msg) {
  const alerts = document.getElementById("alerts");
  const div = document.createElement("div");
  div.className = "alert";
  div.innerText = msg;
  alerts.appendChild(div);
  setTimeout(() => alerts.removeChild(div), 6000);
}

function checkAlerts() {
  rawData.forEach(w => {
    const id = `${w.coin}-${w.type}-${w.exchange}-${w.price}`;
    if (!seenAlerts.has(id)) {
      if (w.value > 1000000) {
        showAlert(`🔥 Mega Wall: ${w.coin} at $${Math.round(w.price)} (${w.type})`);
        seenAlerts.add(id);
      } else if (Math.abs(w.distance) < 1.0) {
        showAlert(`⚠️ Close Wall: ${w.coin} ${w.type} wall <1% from price`);
        seenAlerts.add(id);
      }
    }
  });
}

function resetFilters() {
  document.querySelectorAll(".filters select").forEach(select => select.value = "");
  renderTables();
}

document.querySelectorAll(".filters select").forEach(select => {
  select.addEventListener("change", renderTables);
});

fetchData();
setInterval(fetchData, 10000);
</script>

</body>
</html>
