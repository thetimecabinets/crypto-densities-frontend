<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üêã Whale Wall Tracker ‚Äì CryptoDensities.pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Track real-time crypto whale buy and sell walls by coin. Visualize price levels with high liquidity resistance.">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f3e5f5;
      color: #111;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    canvas#neonGrid {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      width: 100vw;
      height: 100vh;
    }
    nav {
      background-color: #3c1361;
      padding: 15px;
      color: white;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }
    h1 {
      font-size: 32px;
      text-align: center;
      color: #ffffff;
      text-shadow: 0 0 5px #fff, 0 0 10px #6a1b9a, 0 0 20px #6a1b9a, 0 0 40px #ff2dfd;
    }
    .main-layout {
      display: flex;
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 20px;
      gap: 30px;
    }
    .content { flex: 3; }
    .sidebar {
      flex: 1;
      background-color: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(170, 0, 255, 0.15);
      height: fit-content;
    }
    .filters, .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    select, button {
      padding: 6px 10px;
      font-size: 14px;
    }
    .tab-button {
      background-color: #d1c4e9;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
    }
    .tab-button.active {
      background-color: #6a1b9a;
      color: white;
    }
    .coin-table {
      display: none;
    }
    .coin-table.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      margin-bottom: 40px;
      color: black;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }
    .buy { color: green; font-weight: bold; }
    .sell { color: red; font-weight: bold; }
    .pulse {
      animation: pulseGlow 1.5s ease-in-out infinite;
      background-color: #fff8e1 !important;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 0px rgba(255,165,0,0); }
      50% { box-shadow: 0 0 10px rgba(255,165,0,0.8); }
      100% { box-shadow: 0 0 0px rgba(255,165,0,0); }
    }
    .strong { background-color: #c8e6c9; }
    .mid    { background-color: #fff9c4; }
    .weak   { background-color: #ffcdd2; }

    #alerts {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 300px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 9999;
      font-size: 14px;
    }
    .alert {
      background-color: #6a1b9a;
      color: white;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      opacity: 0;
      animation: fadeInOut 6s ease-in-out;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }
    @media (max-width: 900px) {
      .main-layout { flex-direction: column; }
    }
    @media (max-width: 768px) {
      nav { flex-direction: column; align-items: center; }
      .filters { flex-direction: column; }
    }
  </style>
</head>
<body>

<canvas id="neonGrid"></canvas>

<nav>
  <a href="/">üêã Whale Walls</a>
  <a href="/market-sentiment/">üìä Market Sentiment</a>
  <a href="/position-calculator/">üßÆ Position Calculator</a>
  <a href="/how-to-use-whale-wall/">üìò How It Works</a>
</nav>

<div class="main-layout">
  <div class="content">
    <h1>üêã Whale Wall Tracker by Coin</h1>
    <p>Experience real-time monitoring of massive buy and sell walls across major crypto pairs. Filter, explore, and react to where the smart money is placing resistance and support ‚Äî instantly and by coin.</p>

    <div class="filters">
      <!-- filter groups here (same as yours) -->
    </div>

    <div class="tabs" id="coinTabs"></div>
    <div id="heatmapInsights" style="margin-top: 20px;"></div>
    <div id="coinTablesContainer"></div>
  </div>

  <div class="sidebar">
    <h2>üìå Featured Content</h2>
    <p>üß† Learn how to interpret whale walls and price reaction zones.</p>
    <p>üí° Tip: Combine order wall data with momentum shifts to detect fakeouts.</p>
    <p>üî• <a href="/position-calculator/" style="color:#6a1b9a;">Position Calculator</a></p>
    <p>üìò <a href="/how-to-use-whale-wall/" style="color:#004d40;">How This Works</a></p>
  </div>
</div>

<div id="alerts"></div>

<script>
// Neon grid
const canvas = document.getElementById('neonGrid');
const ctx = canvas.getContext('2d');
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
function drawGrid() {
  const spacing = 40;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = 'rgba(0,255,255,0.07)';
  ctx.lineWidth = 1;
  for (let x = 0; x < canvas.width; x += spacing) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
  }
  for (let y = 0; y < canvas.height; y += spacing) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
  }
}
window.addEventListener('resize', () => { resizeCanvas(); drawGrid(); });
resizeCanvas(); drawGrid();

let rawData = [], activeCoin = "", seenAlerts = new Set();

function formatNumberShort(n) {
  if (!n || isNaN(n)) return "N/A";
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toString();
}

async function fetchData() {
  try {
    const res = await fetch("https://api.cryptodensities.pro/api/walls");
    rawData = await res.json();
    renderTabs();
    renderTables();
    checkAlerts();
    fetchInsightsAndRenderHeatmap();
  } catch (err) {
    console.error("Failed to fetch data:", err);
  }
}

function renderTabs() {
  const tabs = document.getElementById("coinTabs");
  let coins = [...new Set(rawData.map(w => w.coin))];
  coins.sort((a, b) => (a === "BTC" ? -1 : b === "BTC" ? 1 : a === "ETH" ? -1 : b === "ETH" ? 1 : a.localeCompare(b)));
  if (!coins.includes(activeCoin)) activeCoin = coins[0];
  tabs.innerHTML = coins.map(coin => `
    <button class="tab-button ${coin === activeCoin ? 'active' : ''}" onclick="setActiveCoin('${coin}')">${coin}</button>
  `).join("");
}

function setActiveCoin(coin) {
  activeCoin = coin;
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  document.querySelectorAll(".tab-button").forEach(btn => {
    if (btn.innerText === coin) btn.classList.add("active");
  });
  renderTables();
}

function renderTables() {
  const container = document.getElementById("coinTablesContainer");
  container.innerHTML = "";
  const exchange = document.getElementById("exchangeFilter")?.value;
  const type = document.getElementById("typeFilter")?.value;
  const value = parseFloat(document.getElementById("valueFilter")?.value) || 0;
  const ageFilter = document.getElementById("ageFilter")?.value;

  const filtered = rawData.filter(w =>
    w.coin === activeCoin &&
    (!exchange || w.exchange === exchange) &&
    (!type || w.type === type) &&
    (!value || w.value >= value) &&
    (!ageFilter || (ageFilter === ">86400" && w.age_seconds > 86400) || (ageFilter !== ">86400" && w.age_seconds <= parseFloat(ageFilter)))
  );

  const rows = filtered.map(w => {
    const icon = w.age_seconds <= 60 ? "üÜï" : w.value > 1000000 ? "üî•" : w.value > 500000 ? "üêã" : "";
    const pulseClass = w.age_seconds <= 60 ? "pulse" : "";
    return `
      <tr class="${pulseClass}">
        <td class="${w.type}">${icon} ${w.type.charAt(0).toUpperCase() + w.type.slice(1)}</td>
        <td>${w.exchange}</td>
        <td>${w.price.toLocaleString()}</td>
        <td>${w.quantity}</td>
        <td>$${formatNumberShort(w.value)}</td>
        <td>${w.distance}</td>
        <td>${w.age}</td>
        <td>${w.volatility ?? 'N/A'}</td>
        <td>$${formatNumberShort(w.volume)}</td>
      </tr>
    `;
  }).join("");

  container.innerHTML = `
    <table class="coin-table active">
      <thead>
        <tr>
          <th>Type</th><th>Exchange</th><th>Price ($)</th><th>Quantity</th>
          <th>Value ($)</th><th>Distance (%)</th><th>Age</th><th>Volatility</th><th>Volume</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function showAlert(msg) {
  const alerts = document.getElementById("alerts");
  const div = document.createElement("div");
  div.className = "alert";
  div.innerText = msg;
  alerts.appendChild(div);
  setTimeout(() => alerts.removeChild(div), 6000);
}

function checkAlerts() {
  rawData.forEach(w => {
    const id = `${w.coin}-${w.type}-${w.exchange}-${w.price}`;
    if (!seenAlerts.has(id)) {
      if (w.value > 1000000) {
        showAlert(`üî• Mega Wall: ${w.coin} at $${Math.round(w.price)} (${w.type})`);
        seenAlerts.add(id);
      } else if (Math.abs(w.distance) < 1.0) {
        showAlert(`‚ö†Ô∏è Close Wall: ${w.coin} ${w.type} wall <1% from price`);
        seenAlerts.add(id);
      }
    }
  });
}

function resetFilters() {
  document.querySelectorAll(".filters select").forEach(select => select.value = "");
  renderTables();
}
document.querySelectorAll(".filters select").forEach(select => {
  select.addEventListener("change", renderTables);
});

// üî• HEATMAP RENDER
async function fetchInsightsAndRenderHeatmap() {
  try {
    const res = await fetch("https://api.cryptodensities.pro/api/insights");
    const insights = await res.json();
    const container = document.getElementById("heatmapInsights");
    if (!insights || !Array.isArray(insights)) return;

    const rows = insights.map(i => {
      const buyRatio = i.buy_ratio ?? 0;
      const value = i.average_value ?? 0;
      const dist = i.average_distance ?? 0;
      const walls = i.wall_count ?? 0;

      const colorCell = (val, thresholds, reverse = false) => {
        let grade;
        if (val >= thresholds[2]) grade = "strong";
        else if (val >= thresholds[1]) grade = "mid";
        else grade = "weak";
        if (reverse) grade = grade === "strong" ? "weak" : grade === "weak" ? "strong" : grade;
        return `<td class="${grade}">${val.toString().includes('%') ? val : formatNumberShort(val)}</td>`;
      };

      return `
        <tr>
          <td><strong>${i.coin}</strong></td>
          ${colorCell(walls, [5, 10, 20])}
          ${colorCell(value, [250000, 500000, 1000000])}
          ${colorCell(dist, [3, 2, 1], true)}
          ${colorCell(`${Math.round(buyRatio * 100)}%`, [30, 50, 70])}
        </tr>
      `;
    }).join("");

    container.innerHTML = `
      <div style="background:white; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); padding: 20px;">
        <h2 style="margin-bottom: 10px;">üìä Whale Wall Heatmap</h2>
        <p style="margin-bottom: 15px;">Live market view by coin: wall count, strength, distance, and buy ratio.</p>
        <div style="overflow-x: auto;">
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th>Coin</th>
                <th>Wall Count</th>
                <th>Avg Value</th>
                <th>Avg Distance</th>
                <th>Buy %</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
  } catch (e) {
    console.error("Failed to fetch heatmap insights:", e);
  }
}

fetchData();
setInterval(fetchData, 10000);
</script>

</body>
</html>
